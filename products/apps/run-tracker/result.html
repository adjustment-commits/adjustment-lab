<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LITE BASE｜記録の推移</title>
<meta name="theme-color" content="#f8faf9">
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: 'Noto Sans JP', sans-serif;
  background: #f8faf9;
  color: #1a1a1a;
  margin: 0;
  padding: 20px;
  max-width: 800px;
  margin: auto;
}
h1 {
  text-align: center;
  color: #00b386;
  margin-bottom: 10px;
}
select {
  display: block;
  margin: 0 auto 30px;
  padding: 8px 12px;
  font-size: 1rem;
  border-radius: 6px;
  border: 1px solid rgba(0,0,0,0.2);
}
canvas {
  margin-bottom: 40px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  padding: 10px;
}
#advice {
  background: #fff;
  border-left: 6px solid #00b386;
  padding: 15px 20px;
  border-radius: 6px;
  margin-top: 20px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  font-size: 0.95rem;
  line-height: 1.7;
}
button {
  display: block;
  margin: 30px auto 0;
  background: #555;
  color: #fff;
  border: none;
  padding: 12px 20px;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.3s;
}
button:hover {
  background: #333;
}
</style>
</head>

<body>

<h1>記録の推移</h1>
<select id="filter">
  <option value="all">全期間</option>
  <option value="month">今月</option>
  <option value="week">今週</option>
</select>

<canvas id="rpeChart" height="150"></canvas>
<canvas id="hrChart" height="150"></canvas>
<canvas id="distanceChart" height="150"></canvas>

<div id="advice"></div>

<button onclick="window.location.href='index.html'">← 記録入力へ戻る</button>

<!-- ===== JS ===== -->
<script>
const ctxRPE = document.getElementById("rpeChart");
const ctxHR = document.getElementById("hrChart");
const ctxDist = document.getElementById("distanceChart");
const filterSelect = document.getElementById("filter");
const adviceBox = document.getElementById("advice");

function filterRecords(records, mode) {
  const now = new Date();
  return records.filter(r => {
    const d = new Date(r.date);
    if (mode === "week") {
      const diff = (now - d) / (1000 * 60 * 60 * 24);
      return diff <= 7;
    }
    if (mode === "month") {
      return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    }
    return true;
  });
}

function analyzePerformance(records) {
  if (!records.length) return "まだ記録がありません。今日から始めましょう。";

  const avgRPE = records.reduce((a,b)=>a+Number(b.rpe),0)/records.length;
  const avgHR = records.filter(b=>b.hr).reduce((a,b)=>a+Number(b.hr||0),0)/records.filter(b=>b.hr).length || 0;
  const totalDist = records.reduce((a,b)=>a+Number(b.distance||0),0);

  if (avgRPE >= 8)
    return "🔥 高強度のトレーニングが続いています。身体の声を聞きつつ、しっかり休養を。";
  if (avgRPE >= 6)
    return "💪 良い負荷で積み上げができています。このリズムを維持しながら、週末は軽めの刺激を。";
  if (avgRPE >= 4)
    return "⚖ 安定したコンディションです。今週は少し負荷を上げても良いタイミングです。";
  return "🌀 低強度が続いています。目的を見直し、意図を持ったトレーニングを再開しましょう。";
}

function renderCharts(mode="all") {
  const raw = JSON.parse(localStorage.getItem("trainingRecords")) || [];
  const data = filterRecords(raw, mode);
  const labels = data.map(d=>d.date);

  const rpe = data.map(d=>d.rpe);
  const hr = data.map(d=>d.hr);
  const dist = data.map(d=>d.distance);

  // RPE
  new Chart(ctxRPE, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "RPE（主観的強度）",
        data: rpe,
        borderColor: "#00b386",
        backgroundColor: "rgba(0,179,134,0.1)",
        fill: true
      }]
    },
    options: { responsive: true, scales: { y: { suggestedMin: 0, suggestedMax: 10 } } }
  });

  // HR
  new Chart(ctxHR, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "心拍数（bpm）",
        data: hr,
        borderColor: "#ff6b6b",
        backgroundColor: "rgba(255,107,107,0.1)",
        fill: true
      }]
    },
    options: { responsive: true }
  });

  // Distance
  new Chart(ctxDist, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "距離（km）",
        data: dist,
        borderColor: "#4a90e2",
        backgroundColor: "rgba(74,144,226,0.1)",
        fill: true
      }]
    },
    options: { responsive: true }
  });

  adviceBox.innerHTML = analyzePerformance(data);
}

filterSelect.addEventListener("change", e => {
  renderCharts(e.target.value);
});

// 初期表示
renderCharts();
</script>

<!-- ===== 共通フッター ===== -->
<div id="footer"></div>
<script>
fetch("/adjustment-lab/assets/footer-lite.html")
  .then(res => res.text())
  .then(html => { document.getElementById("footer").innerHTML = html; });
</script>

</body>
</html>
