<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Run Tracker｜adjustment-lab</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#00b386">
<!-- ✅ PWA統合：manifest / service-worker動的生成 -->
<script>
const manifestData = {
  name: "Run Tracker",
  short_name: "RunTracker",
  start_url: "./index.html",
  display: "standalone",
  background_color: "#00b386",
  theme_color: "#00b386",
  icons: [
    { src: "icon-192.png", sizes: "192x192", type: "image/png" },
    { src: "icon-512.png", sizes: "512x512", type: "image/png" }
  ]
};
const blob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
const manifestURL = URL.createObjectURL(blob);
const link = document.createElement('link');
link.rel = 'manifest';
link.href = manifestURL;
document.head.appendChild(link);

const swCode = `
const CACHE_NAME = "run-tracker-v1";
const FILES_TO_CACHE = ["./", "./index.html"];
self.addEventListener("install", e => {
  e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(FILES_TO_CACHE)));
});
self.addEventListener("fetch", e => {
  e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
});
self.addEventListener("activate", e => {
  e.waitUntil(caches.keys().then(keys =>
    Promise.all(keys.map(k => k !== CACHE_NAME && caches.delete(k)))
  ));
});`;
const swBlob = new Blob([swCode], {type: "text/javascript"});
const swURL = URL.createObjectURL(swBlob);
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => navigator.serviceWorker.register(swURL));
}
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --accent:#00b386; --bg:#f8faf9; --text:#1a1a1a;
}
body {
  font-family:'Noto Sans JP',sans-serif;
  background:var(--bg);
  color:var(--text);
  margin:0;
  padding:20px;
  max-width:720px;
  margin-inline:auto;
  line-height:1.7;
}
h1 {
  text-align:center;
  color:var(--accent);
  margin-top:24px;
  margin-bottom:16px;
}
form {
  background:#fff;
  padding:20px;
  border-radius:8px;
  box-shadow:0 2px 12px rgba(0,0,0,.05);
}
label {
  display:block;
  margin-top:10px;
  font-weight:600;
  color:#333;
}
input, textarea {
  width:100%;
  padding:8px;
  margin-top:4px;
  border:1px solid #ccc;
  border-radius:4px;
  font-size:1rem;
  box-sizing:border-box;
}
button {
  background:var(--accent);
  color:#fff;
  border:none;
  padding:10px 18px;
  border-radius:6px;
  margin-top:14px;
  font-size:1rem;
  cursor:pointer;
  transition:.25s;
}
button:hover { opacity:.9; }

canvas { margin-top:28px; width:100%; height:320px; }

p.comment {
  background:#fff;
  border-left:4px solid var(--accent);
  padding:16px;
  border-radius:6px;
  box-shadow:0 1px 8px rgba(0,0,0,.05);
  margin-top:20px;
}
.controls {
  display:flex;
  justify-content:space-between;
  margin-top:20px;
}
.controls button {
  flex:1;
  margin-inline:4px;
}
footer {
  text-align:center;
  color:#777;
  font-size:13px;
  margin:40px 0 10px;
}
</style>
</head>
<body>
<h1>Run Tracker</h1>
<form id="runForm">
  <label>日付</label>
  <input type="date" id="date" required>
  <textarea id="memo" rows="2" placeholder="走行内容・気づきなど"></textarea>
</form>
<p id="comment" class="comment"></p>
<div class="controls">
  <button id="clearBtn" style="background:#999;">全データ削除</button>
  <button id="viewBtn" onclick="location.href='view.html'">分析ページへ</button>
</div>
<footer>© 2025 adjustment-lab｜Run Tracker</footer>
<script>
const form = document.getElementById("runForm");
const ctx = document.getElementById("chart").getContext("2d");
let chart=null;

form.addEventListener("submit", e=>{
  e.preventDefault();
  const record={
    date:date.value,
    distance:parseFloat(distance.value)||0,
    time:parseFloat(time.value)||0,
    rpe:parseFloat(rpe.value)||0,
    vo2:parseFloat(vo2.value)||null,
    memo:memo.value.trim()
  };
  const records=JSON.parse(localStorage.getItem("runRecords")||"[]");
  records.push(record);
  localStorage.setItem("runRecords",JSON.stringify(records));
  form.reset();
  renderChart();
});

document.getElementById("clearBtn").onclick=()=>{
  if(confirm("すべての記録を削除しますか？")){
    localStorage.removeItem("runRecords");
    if(chart) chart.destroy();
    document.getElementById("comment").textContent="データを削除しました。";
  }
};

function renderChart(){
  const data=JSON.parse(localStorage.getItem("runRecords")||"[]");
  if(!data.length){
    document.getElementById("comment").textContent="まだ記録がありません。";
    if(chart) chart.destroy();
    return;
  }
  const sorted=[...data].sort((a,b)=>new Date(a.date)-new Date(b.date));
  const labels=sorted.map(r=>r.date);
  const dist=sorted.map(r=>r.distance);
  const rpe=sorted.map(r=>r.rpe);
  const vo2=sorted.map(r=>r.vo2);

  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:"line",
    data:{
      labels:labels,
      datasets:[
        {label:"距離(km)",data:dist,borderColor:"#1e90ff",backgroundColor:"rgba(30,144,255,0.2)",yAxisID:"y1"},
        {label:"RPE",data:rpe,borderColor:"#00b386",backgroundColor:"rgba(0,179,134,0.2)",yAxisID:"y"},
        {label:"VO₂max",data:vo2,borderColor:"#8a2be2",backgroundColor:"rgba(138,43,226,0.15)",yAxisID:"y2"}
      ]
    },
    options:{
      responsive:true,
      plugins:{legend:{position:"bottom"}},
      interaction:{mode:"index",intersect:false},
      scales:{
        y:{title:{display:true,text:"RPE"},min:0,max:10},
        y1:{position:"right",grid:{drawOnChartArea:false},title:{display:true,text:"距離(km)"}},
        y2:{position:"right",grid:{drawOnChartArea:false},title:{display:true,text:"VO₂max"}}
      }
    }
  });

  const rpeValid=rpe.filter(v=>!isNaN(v)&&v>0);
  const avgRPE=rpeValid.reduce((a,b)=>a+b,0)/(rpeValid.length||1);
  let text="";
  if(avgRPE>=8) text="高強度が続いています。疲労に注意してリカバリーを挟みましょう。";
  else if(avgRPE>=5) text="適正な負荷ゾーン。パフォーマンスの安定が見込めます。";
  else text="軽い負荷。フォーム確認や呼吸リズムの再構成に最適です。";
  document.getElementById("comment").textContent=text;
}
renderChart();
</script>
</body>
</html>
