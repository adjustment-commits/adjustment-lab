<!DOCTYPE html>
<html lang="ja">
<head>
<!-- ✅ PWA設定 -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#00b386">
<link rel="apple-touch-icon" sizes="192x192" href="/adjustment-lab/products/icons/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="/adjustment-lab/products/icons/icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="VO₂max Tracker">
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js');
  });
}
</script>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VO₂max Tracker｜持久力テスト</title>
<link rel="stylesheet" href="/adjustment-lab/assets/footer-lite.css">

<style>
body {
  font-family: 'Noto Sans JP', sans-serif;
  background: #f8faf9;
  color: #1a1a1a;
  margin: 0;
  padding: 20px;
  max-width: 640px;
  margin: auto;
}
h1 {
  text-align: center;
  color: #00b386;
  margin-bottom: 15px;
}
label {
  display: block;
  margin-top: 20px;
  font-size: 0.95rem;
}
input, select {
  width: 100%;
  padding: 10px;
  border: 1px solid rgba(0,0,0,0.1);
  border-radius: 6px;
  font-size: 1rem;
  box-sizing: border-box;
}
button {
  margin-top: 25px;
  width: 100%;
  background: #00b386;
  color: #fff;
  border: none;
  padding: 12px;
  font-size: 1.1rem;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.3s;
}
button:hover { background: #009270; }

.result-card {
  background: #fff;
  margin-top: 25px;
  border-radius: 8px;
  padding: 18px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  text-align: center;
}
.result-card h2 {
  margin: 0;
  color: #00b386;
  font-size: 1.6rem;
}
.result-card p {
  margin: 10px 0;
  line-height: 1.6;
}
canvas {
  width: 100%;
  height: 280px;
  margin-top: 25px;
}
footer { margin-top: 60px; }
</style>
</head>

<body>
<h1>VO₂max Tracker</h1>

<form id="vo2Form">
  <label>テスト種別</label>
  <select id="testType" required>
    <option value="cooper">クーパー走（12分間走）</option>
    <option value="shuttle">シャトルラン（20m）</option>
    <option value="yoyo">YoYoテスト</option>
    <option value="custom">任意距離＆時間</option>
  </select>

  <div id="inputFields"></div>
  <button type="submit">VO₂maxを計算</button>
</form>

<div id="result" class="result-card" style="display:none;">
  <h2 id="vo2Value"></h2>
  <p id="comment"></p>
</div>

<canvas id="vo2Chart"></canvas>

<button onclick="window.location.href='index.html'" style="margin-top:25px;background:#555;">← RUN TRACKERに戻る</button>

<!-- Footer -->
<div id="footer"></div>
<script>
fetch("/adjustment-lab/assets/footer-lite.html")
  .then(res => res.text())
  .then(html => { document.getElementById("footer").innerHTML = html; });
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const inputFields = document.getElementById("inputFields");
const form = document.getElementById("vo2Form");
const resultCard = document.getElementById("result");
const vo2Value = document.getElementById("vo2Value");
const comment = document.getElementById("comment");

const chartCanvas = document.getElementById("vo2Chart");
let vo2Chart;

document.getElementById("testType").addEventListener("change", updateInputFields);
updateInputFields();

function updateInputFields() {
  const type = document.getElementById("testType").value;
  let html = "";
  if (type === "cooper") {
    html = '<label>走行距離（m）</label><input type="number" id="distance" placeholder="例：2800" required>';
  } else if (type === "shuttle") {
    html = '<label>最終速度（km/h）</label><input type="number" id="speed" placeholder="例：12.5" step="0.1" required>';
  } else if (type === "yoyo") {
    html = '<label>最終速度（km/h）</label><input type="number" id="speed" placeholder="例：14.5" step="0.1" required>';
  } else {
    html = `
      <label>距離（m）</label><input type="number" id="distance" placeholder="例：1500" required>
      <label>時間（秒）</label><input type="number" id="time" placeholder="例：420" required>
    `;
  }
  inputFields.innerHTML = html;
}

form.addEventListener("submit", (e) => {
  e.preventDefault();
  const type = document.getElementById("testType").value;
  let vo2 = 0;

  if (type === "cooper") {
    const distance = Number(document.getElementById("distance").value);
    vo2 = (distance - 504.9) / 44.73;
  } else if (type === "shuttle") {
    const speed = Number(document.getElementById("speed").value);
    vo2 = 6.0 * speed - 24.4;
  } else if (type === "yoyo") {
    const speed = Number(document.getElementById("speed").value);
    vo2 = 15.3 * speed - 92.0;
  } else {
    const distance = Number(document.getElementById("distance").value);
    const time = Number(document.getElementById("time").value);
    const velocity = distance / time;
    vo2 = velocity * 1000 * 0.2 + 3.5;
  }

  vo2 = Math.max(0, vo2);
  const vo2Rounded = vo2.toFixed(1);
  let msg = "";
  if (vo2 < 40) msg = "一般成人レベルです。継続的なトレーニングで基礎持久力を高めましょう。";
  else if (vo2 < 50) msg = "競技基礎レベルです。安定したペース走やインターバルを取り入れましょう。";
  else if (vo2 < 60) msg = "高い持久力が身についています。試合終盤のスタミナにも強みを発揮できます。";
  else msg = "エリートクラスのVO₂maxです。出力と持久の両立が素晴らしい状態です。";

  vo2Value.textContent = `VO₂max：${vo2Rounded}`;
  comment.textContent = msg;
  resultCard.style.display = "block";

  // === 記録保存 ===
  const record = { date: new Date().toISOString().split('T')[0], type, vo2: vo2Rounded };
  let records = JSON.parse(localStorage.getItem("vo2Records")) || [];
  records.push(record);
  localStorage.setItem("vo2Records", JSON.stringify(records));

  renderChart(records);
});

function renderChart(records) {
  const dates = records.map(r => r.date);
  const values = records.map(r => r.vo2);

  if (vo2Chart) vo2Chart.destroy();
  const ctx = chartCanvas.getContext('2d');
  vo2Chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'VO₂max 推移',
        data: values,
        borderColor: '#00b386',
        backgroundColor: 'rgba(0,179,134,0.15)',
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { title: { display: true, text: 'VO₂max' }, min: 30, max: 75 }
      }
    }
  });
}

// 初期描画
const saved = JSON.parse(localStorage.getItem("vo2Records")) || [];
if (saved.length > 0) renderChart(saved);
</script>
</body>
</html>
