<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>adjustment-lab｜App Base Template</title>

<!-- ✅ PWA設定 -->
<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#00b386">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="adjustment-lab App">
<link rel="apple-touch-icon" sizes="192x192" href="/adjustment-lab/products/icons/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="/adjustment-lab/products/icons/icon-512.png">

<style>
body {
  margin: 0;
  font-family: 'Noto Sans JP', sans-serif;
  background: #fff;
  color: #111;
  -webkit-tap-highlight-color: transparent;
}

/* ✅ プレースホルダーUI（各アプリがここにUIを挿入） */
main {
  padding: 40px 20px;
  text-align: center;
}

/* ✅ 共通のフェードアニメーション（UI要素用） */
.fade-in {
  opacity: 0;
  animation: fadeIn 0.8s forwards;
}
@keyframes fadeIn {
  to { opacity: 1; }
}
</style>
</head>

<body>
<main>
  <h1>adjustment-lab Base Template</h1>
  <p>このテンプレートは、全アプリ共通のPWA制御を提供します。</p>
  <p>各アプリでUI（バナー、モーダル、ウェルカムなど）を追加してください。</p>
</main>

<script>
// =====================================================
// ✅ Service Worker 登録
// =====================================================
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('../service-worker.js')
      .then(reg => console.log('[PWA] Service Worker registered:', reg.scope))
      .catch(err => console.warn('[PWA] SW registration failed:', err));
  });
}

// =====================================================
// ✅ PWAインストール制御
// =====================================================
let deferredPrompt;
const appKey = 'adjustmentLabAppInstalled';

// すでにインストール済みか localStorage で確認
const isInstalled = localStorage.getItem(appKey) === 'true';

// ✅ Android / PC向け beforeinstallprompt
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  console.log('[PWA] beforeinstallprompt 発火');

  // まだインストールされていない場合のみ通知
  if (!isInstalled && !window.matchMedia('(display-mode: standalone)').matches) {
    // 各アプリ側でバナーを出す処理をここで呼ぶ
    const event = new CustomEvent('showInstallBanner', { detail: deferredPrompt });
    window.dispatchEvent(event);
  }
});

// ✅ インストール完了検知
window.addEventListener('appinstalled', () => {
  console.log('[PWA] インストール完了');
  localStorage.setItem(appKey, 'true');
});

// =====================================================
// ✅ display-mode 判定（インストール済み or ブラウザ起動）
// =====================================================
function getDisplayMode() {
  if (document.referrer.startsWith('android-app://')) {
    return 'twa';
  }
  if (window.matchMedia('(display-mode: standalone)').matches) {
    return 'standalone';
  }
  return 'browser';
}

window.addEventListener('DOMContentLoaded', () => {
  const mode = getDisplayMode();
  console.log('[PWA] display-mode:', mode);

  if (mode === 'standalone') {
    localStorage.setItem(appKey, 'true');
  }
});

// =====================================================
// ✅ iOS向けガイドモーダル制御（アプリ側で利用）
// =====================================================
function shouldShowIosGuide() {
  const ua = window.navigator.userAgent.toLowerCase();
  const isIos = /iphone|ipad|ipod/.test(ua);
  const isInStandalone = window.navigator.standalone === true;
  return isIos && !isInStandalone && !isInstalled;
}

// 各アプリ側で利用するため export
window.adjustmentLabPWA = {
  deferredPrompt,
  getDisplayMode,
  shouldShowIosGuide
};
</script>

</body>
</html>
