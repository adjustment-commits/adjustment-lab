<!DOCTYPE html>
<html lang="ja">
<head>
<!-- âœ… PWAè¨­å®š -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#00b386">
<link rel="apple-touch-icon" sizes="192x192" href="/adjustment-lab/products/icons/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="/adjustment-lab/products/icons/icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Recovery Tracker">
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js');
  });
}
</script>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recovery Trackerï½œè¨˜éŒ²ã‚°ãƒ©ãƒ•</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="/adjustment-lab/assets/footer-lite.css">

<style>
body {
  font-family: 'Noto Sans JP', sans-serif;
  background: #f8faf9;
  color: #1a1a1a;
  margin: 0;
  padding: 20px;
  max-width: 800px;
  margin: auto;
}
h1 {
  text-align: center;
  color: #00b386;
  margin-bottom: 20px;
}
canvas {
  width: 100%;
  max-height: 400px;
  margin-top: 20px;
}
button {
  width: 100%;
  background: #00b386;
  color: #fff;
  border: none;
  padding: 12px;
  font-size: 1.1rem;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.3s;
}
button:hover { background: #009270; }

#average {
  margin-top: 20px;
  text-align: center;
  font-weight: 600;
  color: #009270;
}

.feedback-card {
  margin-top: 25px;
  background: #ffffff;
  border: 1px solid rgba(0,0,0,0.05);
  border-left: 5px solid #00b386;
  border-radius: 8px;
  padding: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
.feedback-card h3 {
  margin: 0 0 8px;
  color: #00b386;
  font-size: 1.1rem;
}
.feedback-card p {
  margin: 4px 0;
  line-height: 1.8;
}

#deleteAll {
  background: #d84a4a;
  margin-top: 20px;
}
#deleteAll:hover {
  background: #b83636;
}
</style>
</head>

<body>

<h1>Recovery Tracker</h1>

<canvas id="recoveryChart"></canvas>

<div id="average"></div>
<div id="feedback"></div>

<button onclick="window.location.href='index.html'" style="margin-top:25px;">å…¥åŠ›ç”»é¢ã¸æˆ»ã‚‹</button>
<button id="deleteAll">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹</button>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const ctx = document.getElementById("recoveryChart").getContext("2d");
  const data = JSON.parse(localStorage.getItem("recoveryRecords")) || [];

  // === å‰Šé™¤ãƒœã‚¿ãƒ³ ===
  document.getElementById("deleteAll").addEventListener("click", () => {
    if (confirm("âš ï¸ å…¨ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚")) {
      localStorage.removeItem("recoveryRecords");
      alert("ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
      location.reload();
    }
  });

  if (data.length === 0) {
    document.getElementById("average").textContent = "ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
    return;
  }

  const labels = data.map(r => r.date);
  const sleep = data.map(r => parseFloat(r.sleep || 0));
  const fatigue = data.map(r => parseFloat(r.fatigue || 0));
  const muscle = data.map(r => parseFloat(r.muscle || 0));
  const appetite = data.map(r => parseFloat(r.appetite || 0));
  const mental = data.map(r => parseFloat(r.mental || 0));

  const avg = (arr) => (arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(1);

  const avgData = {
    sleep: avg(sleep),
    fatigue: avg(fatigue),
    muscle: avg(muscle),
    appetite: avg(appetite),
    mental: avg(mental)
  };

  document.getElementById("average").innerHTML = `
    ğŸ’¤ ç¡çœ å¹³å‡ï¼š${avgData.sleep}hã€€
    âš¡ ç–²åŠ´å¹³å‡ï¼š${avgData.fatigue}ã€€
    ğŸ’ª ç­‹è‚‰ç—›å¹³å‡ï¼š${avgData.muscle}ã€€
    ğŸ½ï¸ é£Ÿæ¬²å¹³å‡ï¼š${avgData.appetite}ã€€
    ğŸ§  ãƒ¡ãƒ³ã‚¿ãƒ«å¹³å‡ï¼š${avgData.mental}
  `;

  new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        { label: "ç¡çœ (h)", data: sleep, borderColor: "#007b3a", backgroundColor: "rgba(0,123,58,0.1)", tension: 0.3 },
        { label: "ç–²åŠ´(1-10)", data: fatigue, borderColor: "#ff9800", backgroundColor: "rgba(255,152,0,0.1)", tension: 0.3 },
        { label: "ç­‹è‚‰ç—›(1-5)", data: muscle, borderColor: "#e91e63", backgroundColor: "rgba(233,30,99,0.1)", tension: 0.3 },
        { label: "é£Ÿæ¬²(1-5)", data: appetite, borderColor: "#2196f3", backgroundColor: "rgba(33,150,243,0.1)", tension: 0.3 },
        { label: "ãƒ¡ãƒ³ã‚¿ãƒ«(1-5)", data: mental, borderColor: "#9c27b0", backgroundColor: "rgba(156,39,176,0.1)", tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "bottom" },
        title: { display: true, text: "ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³æ¨ç§»", color: "#333" }
      },
      scales: {
        y: { beginAtZero: true, ticks: { stepSize: 1 } }
      }
    }
  });

  // === ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆé–¢æ•° ===
  function generateFeedback(avgData) {
    const { sleep, fatigue, muscle, appetite, mental } = avgData;
    let feedbacks = [];

    if (sleep < 6) feedbacks.push("ğŸ’¤ ç¡çœ ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆ6æ™‚é–“æœªæº€ï¼‰ã€‚");
    if (fatigue > 7) feedbacks.push("âš¡ å¼·ã„ç–²åŠ´ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚ä»Šæ—¥ã¯èª¿æ•´ã‚’å„ªå…ˆã—ã¾ã—ã‚‡ã†ã€‚");
    if (muscle > 4) feedbacks.push("ğŸ’ª ç­‹è‚‰ç—›ãŒå¼·ã„çŠ¶æ…‹ã€‚è»½ã„é‹å‹•ã§è¡€æµã‚’ä¿ƒã—ã¾ã—ã‚‡ã†ã€‚");
    if (appetite < 3) feedbacks.push("ğŸ½ï¸ é£Ÿæ¬²ãŒä½ä¸‹ã—ã¦ã„ã¾ã™ã€‚æ „é¤Šæ‘‚å–ã‚’æ„è­˜ã€‚");
    if (mental < 3) feedbacks.push("ğŸ§  ãƒ¡ãƒ³ã‚¿ãƒ«ãŒè½ã¡æ°—å‘³ã€‚ç¡çœ ã¨æ°—åˆ†è»¢æ›ã‚’ã€‚");

    if (sleep < 6 && fatigue > 6)
      feedbacks.push("ç¡çœ ä¸è¶³ãŒç–²åŠ´ã‚’æ‚ªåŒ–ã•ã›ã¦ã„ã¾ã™ã€‚ä¼‘é¤Šã‚’å„ªå…ˆã—ã¾ã—ã‚‡ã†ã€‚");
    if (mental < 3 && fatigue > 6)
      feedbacks.push("ã‚¹ãƒˆãƒ¬ã‚¹ã«ã‚ˆã‚‹ç–²åŠ´å‚¾å‘ã€‚ãƒªã‚«ãƒãƒªãƒ¼ãƒ‡ã‚¤ã‚’è¨­ã‘ã¾ã—ã‚‡ã†ã€‚");
    if (muscle > 3 && sleep < 6)
      feedbacks.push("ç­‹ä¿®å¾©ãŒé…ã‚Œã¦ã„ã¾ã™ã€‚ã‚¿ãƒ³ãƒ‘ã‚¯è³ªè£œçµ¦ã‚’æ„è­˜ã€‚");

    const score = (sleep/8 + (10 - fatigue)/10 + (5 - muscle)/5 + appetite/5 + mental/5) / 5;
    if (score >= 0.8)
      feedbacks.push("ğŸŒ¿ å…¨ä½“çš„ã«è‰¯å¥½ã€‚é«˜å¼·åº¦ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚‚å¯èƒ½ã€‚");
    else if (score >= 0.6)
      feedbacks.push("å®‰å®šå‚¾å‘ã€‚ç–²åŠ´ã¨ç¡çœ ã®ãƒãƒ©ãƒ³ã‚¹ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚");
    else
      feedbacks.push("âš ï¸ å›å¾©ãŒé…ã‚Œã¦ã„ã¾ã™ã€‚2ã€œ3æ—¥ã®èª¿æ•´æœŸé–“ã‚’è¨­ã‘ã¦ãã ã•ã„ã€‚");

    return feedbacks;
  }

  const fbList = generateFeedback(avgData);
  const fbContainer = document.getElementById("feedback");

  fbList.forEach((text, i) => {
    const card = document.createElement("div");
    card.className = "feedback-card";
    card.innerHTML = `<h3>Comment ${i+1}</h3><p>${text}</p>`;
    fbContainer.appendChild(card);
  });
});
</script>

<div id="footer"></div>
<script>
fetch("/adjustment-lab/assets/footer-lite.html")
  .then(res => res.text())
  .then(html => { document.getElementById("footer").innerHTML = html; });
</script>

</body>
</html>
