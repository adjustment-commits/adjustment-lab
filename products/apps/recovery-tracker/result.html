<!DOCTYPE html>
<html lang="ja">
<head>
<!-- ✅ PWA設定 -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#00b386">
<link rel="apple-touch-icon" sizes="192x192" href="/adjustment-lab/products/icons/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="/adjustment-lab/products/icons/icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Recovery Tracker">
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js');
  });
}
</script>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recovery Tracker｜記録グラフ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="/adjustment-lab/assets/footer-lite.css">

<style>
body {
  font-family: 'Noto Sans JP', sans-serif;
  background: #f8faf9;
  color: #1a1a1a;
  margin: 0;
  padding: 20px;
  max-width: 800px;
  margin: auto;
}
h1 {
  text-align: center;
  color: #00b386;
  margin-bottom: 20px;
}
canvas {
  width: 100%;
  max-height: 400px;
  margin-top: 20px;
}
button {
  width: 100%;
  background: #00b386;
  color: #fff;
  border: none;
  padding: 12px;
  font-size: 1.1rem;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.3s;
}
button:hover { background: #009270; }

#average {
  margin-top: 20px;
  text-align: center;
  font-weight: 600;
  color: #009270;
}

.feedback-card {
  margin-top: 25px;
  background: #ffffff;
  border: 1px solid rgba(0,0,0,0.05);
  border-left: 5px solid #00b386;
  border-radius: 8px;
  padding: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
.feedback-card h3 {
  margin: 0 0 8px;
  color: #00b386;
  font-size: 1.1rem;
}
.feedback-card p {
  margin: 4px 0;
  line-height: 1.8;
}

#deleteAll {
  background: #d84a4a;
  margin-top: 20px;
}
#deleteAll:hover {
  background: #b83636;
}
</style>
</head>

<body>

<h1>Recovery Tracker</h1>

<canvas id="recoveryChart"></canvas>

<div id="average"></div>
<div id="feedback"></div>

<button onclick="window.location.href='index.html'" style="margin-top:25px;">入力画面へ戻る</button>
<button id="deleteAll">全データを削除する</button>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const ctx = document.getElementById("recoveryChart").getContext("2d");
  const data = JSON.parse(localStorage.getItem("recoveryRecords")) || [];

  // === 削除ボタン ===
  document.getElementById("deleteAll").addEventListener("click", () => {
    if (confirm("⚠️ 全ての記録を削除しますか？ この操作は元に戻せません。")) {
      localStorage.removeItem("recoveryRecords");
      alert("データを削除しました。");
      location.reload();
    }
  });

  if (data.length === 0) {
    document.getElementById("average").textContent = "データがありません。";
    return;
  }

  const labels = data.map(r => r.date);
  const sleep = data.map(r => parseFloat(r.sleep || 0));
  const fatigue = data.map(r => parseFloat(r.fatigue || 0));
  const muscle = data.map(r => parseFloat(r.muscle || 0));
  const appetite = data.map(r => parseFloat(r.appetite || 0));
  const mental = data.map(r => parseFloat(r.mental || 0));

  const avg = (arr) => (arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(1);

  const avgData = {
    sleep: avg(sleep),
    fatigue: avg(fatigue),
    muscle: avg(muscle),
    appetite: avg(appetite),
    mental: avg(mental)
  };

  document.getElementById("average").innerHTML = `
    💤 睡眠平均：${avgData.sleep}h　
    ⚡ 疲労平均：${avgData.fatigue}　
    💪 筋肉痛平均：${avgData.muscle}　
    🍽️ 食欲平均：${avgData.appetite}　
    🧠 メンタル平均：${avgData.mental}
  `;

  new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        { label: "睡眠(h)", data: sleep, borderColor: "#007b3a", backgroundColor: "rgba(0,123,58,0.1)", tension: 0.3 },
        { label: "疲労(1-10)", data: fatigue, borderColor: "#ff9800", backgroundColor: "rgba(255,152,0,0.1)", tension: 0.3 },
        { label: "筋肉痛(1-5)", data: muscle, borderColor: "#e91e63", backgroundColor: "rgba(233,30,99,0.1)", tension: 0.3 },
        { label: "食欲(1-5)", data: appetite, borderColor: "#2196f3", backgroundColor: "rgba(33,150,243,0.1)", tension: 0.3 },
        { label: "メンタル(1-5)", data: mental, borderColor: "#9c27b0", backgroundColor: "rgba(156,39,176,0.1)", tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "bottom" },
        title: { display: true, text: "コンディション推移", color: "#333" }
      },
      scales: {
        y: { beginAtZero: true, ticks: { stepSize: 1 } }
      }
    }
  });

  // === コメント生成関数 ===
  function generateFeedback(avgData) {
    const { sleep, fatigue, muscle, appetite, mental } = avgData;
    let feedbacks = [];

    if (sleep < 6) feedbacks.push("💤 睡眠が不足しています（6時間未満）。");
    if (fatigue > 7) feedbacks.push("⚡ 強い疲労が見られます。今日は調整を優先しましょう。");
    if (muscle > 4) feedbacks.push("💪 筋肉痛が強い状態。軽い運動で血流を促しましょう。");
    if (appetite < 3) feedbacks.push("🍽️ 食欲が低下しています。栄養摂取を意識。");
    if (mental < 3) feedbacks.push("🧠 メンタルが落ち気味。睡眠と気分転換を。");

    if (sleep < 6 && fatigue > 6)
      feedbacks.push("睡眠不足が疲労を悪化させています。休養を優先しましょう。");
    if (mental < 3 && fatigue > 6)
      feedbacks.push("ストレスによる疲労傾向。リカバリーデイを設けましょう。");
    if (muscle > 3 && sleep < 6)
      feedbacks.push("筋修復が遅れています。タンパク質補給を意識。");

    const score = (sleep/8 + (10 - fatigue)/10 + (5 - muscle)/5 + appetite/5 + mental/5) / 5;
    if (score >= 0.8)
      feedbacks.push("🌿 全体的に良好。高強度トレーニングも可能。");
    else if (score >= 0.6)
      feedbacks.push("安定傾向。疲労と睡眠のバランスを維持しましょう。");
    else
      feedbacks.push("⚠️ 回復が遅れています。2〜3日の調整期間を設けてください。");

    return feedbacks;
  }

  const fbList = generateFeedback(avgData);
  const fbContainer = document.getElementById("feedback");

  fbList.forEach((text, i) => {
    const card = document.createElement("div");
    card.className = "feedback-card";
    card.innerHTML = `<h3>Comment ${i+1}</h3><p>${text}</p>`;
    fbContainer.appendChild(card);
  });
});
</script>

<div id="footer"></div>
<script>
fetch("/adjustment-lab/assets/footer-lite.html")
  .then(res => res.text())
  .then(html => { document.getElementById("footer").innerHTML = html; });
</script>

</body>
</html>
