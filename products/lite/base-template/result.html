<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LITE BASE｜グラフ表示</title>
<meta name="theme-color" content="#f8faf9">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: 'Noto Sans JP', sans-serif;
  background: #f8faf9;
  color: #1a1a1a;
  margin: 0;
  padding: 20px;
  max-width: 700px;
  margin: auto;
}
h1 {
  text-align: center;
  color: #00b386;
  margin-bottom: 10px;
}
canvas {
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  padding: 10px;
}
button {
  display: block;
  width: 100%;
  background: #00b386;
  color: #fff;
  border: none;
  padding: 12px;
  font-size: 1.1rem;
  border-radius: 6px;
  margin-top: 30px;
  cursor: pointer;
  transition: 0.3s;
}
button:hover {
  background: #009270;
}
#noData {
  text-align: center;
  margin-top: 40px;
  color: #666;
}
.filter-bar {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 15px;
}
.filter-btn {
  border: 1px solid #00b386;
  color: #00b386;
  background: #fff;
  border-radius: 20px;
  padding: 6px 14px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: 0.3s;
}
.filter-btn.active, .filter-btn:hover {
  background: #00b386;
  color: #fff;
}
</style>
</head>

<body>
<h1>トレーニング記録グラフ</h1>

<div class="filter-bar">
  <button class="filter-btn active" data-range="all">全期間</button>
  <button class="filter-btn" data-range="7">直近7日</button>
  <button class="filter-btn" data-range="30">直近30日</button>
</div>

<canvas id="trainingChart"></canvas>
<div id="noData" style="display:none;">📉 データがまだありません。</div>

<button onclick="window.location.href='index.html'">← 記録入力に戻る</button>

<script>
let chart;
const ctx = document.getElementById("trainingChart");

document.addEventListener("DOMContentLoaded", () => {
  renderChart("all"); // 初期表示は全期間
  setupFilters();
});

function setupFilters() {
  document.querySelectorAll(".filter-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      renderChart(btn.dataset.range);
    });
  });
}

function renderChart(range) {
  const data = JSON.parse(localStorage.getItem("trainingRecords")) || [];
  if (data.length === 0) {
    document.getElementById("noData").style.display = "block";
    ctx.style.display = "none";
    return;
  }

  document.getElementById("noData").style.display = "none";
  ctx.style.display = "block";

  data.sort((a,b) => new Date(a.date) - new Date(b.date));

  const today = new Date();
  let filtered = data;

  if (range !== "all") {
    const days = Number(range);
    const cutoff = new Date(today - days * 86400000);
    filtered = data.filter(d => new Date(d.date) >= cutoff);
  }

  const labels = filtered.map(d => d.date);
  const rpe = filtered.map(d => Number(d.rpe));
  const hr = filtered.map(d => Number(d.hr) || null);
  const distance = filtered.map(d => Number(d.distance) || null);

  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        {
          label: "RPE（主観的強度）",
          data: rpe,
          borderColor: "#00b386",
          backgroundColor: "rgba(0,179,134,0.2)",
          tension: 0.3,
          fill: false
        },
        {
          label: "距離（km）",
          data: distance,
          borderColor: "#009e60",
          backgroundColor: "rgba(0,158,96,0.2)",
          tension: 0.3,
          fill: false
        },
        {
          label: "心拍数（bpm）",
          data: hr,
          borderColor: "#ff7043",
          backgroundColor: "rgba(255,112,67,0.2)",
          tension: 0.3,
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true },
        x: { ticks: { autoSkip: true, maxTicksLimit: 7 } }
      },
      plugins: {
        legend: { position: "bottom" },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + "：" + context.parsed.y;
            }
          }
        }
      }
    }
  });
}
</script>

<!-- ===== 共通フッター ===== -->
<div id="footer"></div>
<script>
fetch("/adjustment-lab/assets/footer-lite.html")
  .then(res => res.text())
  .then(html => { document.getElementById("footer").innerHTML = html; });
</script>
</body>
</html>
